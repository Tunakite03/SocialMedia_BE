// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum PostType {
  TEXT
  IMAGE
  VIDEO
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  VOICE
}

enum ConversationType {
  DIRECT
  GROUP
}

enum ConversationMemberRole {
  ADMIN
  MEMBER
}

enum NotificationType {
  REACT
  COMMENT
  FOLLOW
  MESSAGE
  CALL
  MENTION
}

enum CallType {
  VOICE
  VIDEO
}

enum CallStatus {
  PENDING
  ONGOING
  ENDED
  MISSED
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  ANGRY
  SAD
  WOW
}

enum SentimentType {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  username         String    @unique
  password         String
  displayName      String
  avatar           String?
  bio              String?
  dateOfBirth      DateTime?
  role             UserRole  @default(USER)
  isActive         Boolean   @default(true)
  isOnline         Boolean   @default(false)
  lastSeen         DateTime?
  emailVerified    Boolean   @default(false)
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  posts             Post[]
  comments          Comment[]
  reactions         Reaction[]
  sentMessages      Message[]                 @relation("SentMessages")
  conversations     ConversationParticipant[]
  notifications     Notification[]            @relation("NotificationReceiver")
  sentNotifications Notification[]            @relation("NotificationSender")
  initiatedCalls    Call[]                    @relation("CallInitiator")
  receivedCalls     Call[]                    @relation("CallReceiver")
  followers         Follow[]                  @relation("UserFollowers")
  following         Follow[]                  @relation("UserFollowing")
  sentimentAnalyses SentimentAnalysis[]
  sessions          Session[]
  messageReactions  MessageReaction[]
  messageReadReceipts MessageReadReceipt[]
  callParticipants  CallParticipant[]

  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([refreshToken])
  @@index([expiresAt])
  @@map("sessions")
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("follows")
}

model Post {
  id        String   @id @default(uuid())
  content   String
  type      PostType @default(TEXT)
  mediaUrl  String?
  isPublic  Boolean  @default(true)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments  Comment[]
  reactions Reaction[]

  // Indexes for performance optimization
  @@index([isPublic, createdAt(sort: Desc)]) // For feed pagination
  @@index([type, isPublic, createdAt(sort: Desc)]) // For filtered feed
  @@index([authorId, createdAt(sort: Desc)]) // For user posts
  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  postId    String
  authorId  String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  post      Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]  @relation("CommentReplies")
  reactions Reaction[]

  @@map("comments")
}

model Reaction {
  id        String       @id @default(uuid())
  type      ReactionType
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime     @default(now())

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@map("reactions")
}

model Conversation {
  id        String           @id @default(uuid())
  title     String?
  type      ConversationType @default(DIRECT)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  participants ConversationParticipant[]
  messages     Message[]
  calls        Call[]

  @@map("conversations")
}

model ConversationParticipant {
  id                String                 @id @default(uuid())
  conversationId    String
  userId            String
  role              ConversationMemberRole @default(MEMBER)
  joinedAt          DateTime               @default(now())
  leftAt            DateTime?
  lastReadMessageId String?                // Last message read by this user
  lastReadAt        DateTime?              // When the last message was read

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadMessage Message?     @relation("UserLastReadMessage", fields: [lastReadMessageId], references: [id], onDelete: SetNull)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([lastReadMessageId])
  @@map("conversation_participants")
}

model Message {
  id             String      @id @default(uuid())
  content        String
  type           MessageType @default(TEXT)
  mediaUrl       String?
  conversationId String
  senderId       String
  parentId       String? // For reply feature
  isRead         Boolean     @default(false)
  readAt         DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  conversation        Conversation               @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender              User                       @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  parent              Message?                   @relation("MessageReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies             Message[]                  @relation("MessageReplies")
  attachments         MessageAttachment[]
  reactions           MessageReaction[]
  readReceipts        MessageReadReceipt[]
  lastReadByUsers     ConversationParticipant[]  @relation("UserLastReadMessage")

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model MessageAttachment {
  id        String      @id @default(uuid())
  messageId String
  url       String
  type      MessageType
  size      Int? // File size in bytes
  createdAt DateTime    @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_attachments")
}

model MessageReaction {
  id        String       @id @default(uuid())
  messageId String
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, type])
  @@index([userId])
  @@map("message_reactions")
}

model MessageReadReceipt {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())
  createdAt DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId, readAt])
  @@index([messageId, readAt])
  @@map("message_read_receipts")
}

model Notification {
  id         String           @id @default(uuid())
  type       NotificationType
  title      String
  message    String
  isRead     Boolean          @default(false)
  receiverId String
  senderId   String?
  entityId   String?
  entityType String?
  createdAt  DateTime         @default(now())

  // Relations
  receiver User  @relation("NotificationReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender   User? @relation("NotificationSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Call {
  id             String     @id @default(uuid())
  conversationId String
  type           CallType
  status         CallStatus @default(PENDING)
  duration       Int? // in seconds
  callerId       String
  receiverId     String
  startedAt      DateTime?
  endedAt        DateTime?
  createdAt      DateTime   @default(now())

  // Relations
  conversation Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  caller       User              @relation("CallInitiator", fields: [callerId], references: [id], onDelete: Cascade)
  receiver     User              @relation("CallReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  participants CallParticipant[]
  transcripts  CallTranscript[]

  @@index([conversationId, startedAt])
  @@map("calls")
}

model CallParticipant {
  id       String    @id @default(uuid())
  callId   String
  userId   String
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  // Relations
  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([callId, userId])
  @@index([userId])
  @@map("call_participants")
}

model CallTranscript {
  id         String   @id @default(uuid())
  callId     String
  language   String
  provider   String
  text       String
  confidence Float?
  createdAt  DateTime @default(now())

  // Relations
  call Call @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId, createdAt])
  @@map("call_transcripts")
}

model SentimentAnalysis {
  id         String        @id @default(uuid())
  content    String
  sentiment  SentimentType
  confidence Float
  userId     String
  entityId   String // Can be postId, commentId, messageId
  entityType String // 'post', 'comment', 'message'
  createdAt  DateTime      @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sentiment_analyses")
}
