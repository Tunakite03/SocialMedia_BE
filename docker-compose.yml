version: '3.8'

services:
   # PostgreSQL Database
   postgres:
      image: postgres:15-alpine
      container_name: onway_postgres
      environment:
         POSTGRES_DB: onway_db
         POSTGRES_USER: postgres
         POSTGRES_PASSWORD: password123
      ports:
         - '5432:5432'
      volumes:
         - postgres_data:/var/lib/postgresql/data
         - ./database/init:/docker-entrypoint-initdb.d
      networks:
         - onway_network
      restart: unless-stopped

   # Redis (optional - for session management)
   redis:
      image: redis:7-alpine
      container_name: onway_redis
      ports:
         - '6379:6379'
      volumes:
         - redis_data:/data
      networks:
         - onway_network
      restart: unless-stopped

   # FastAPI Sentiment Service
   sentiment-service:
      build: ./sentiment-service
      container_name: onway_sentiment
      environment:
         - HOST=0.0.0.0
         - PORT=8000
      ports:
         - '8000:8000'
      volumes:
         - ./sentiment-service:/app
      networks:
         - onway_network
      restart: unless-stopped
      depends_on:
         - postgres

   # Node.js Main Application
   app:
      build: .
      container_name: onway_app
      environment:
         - NODE_ENV=production
         - PORT=3000
         - DATABASE_URL=postgresql://postgres:password123@postgres:5432/onway_db
         - JWT_SECRET=your_super_secret_jwt_key_here_change_in_production
         - SENTIMENT_SERVICE_URL=http://sentiment-service:8000
         - REDIS_URL=redis://redis:6379
         - ALLOWED_ORIGINS=http://localhost:3001,https://yourdomain.com
      ports:
         - '3000:3000'
      volumes:
         - ./uploads:/app/uploads
      networks:
         - onway_network
      restart: unless-stopped
      depends_on:
         - postgres
         - redis
         - sentiment-service
      healthcheck:
         test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
         interval: 30s
         timeout: 10s
         retries: 3

   # Nginx Reverse Proxy (optional)
   nginx:
      image: nginx:alpine
      container_name: onway_nginx
      ports:
         - '80:80'
         - '443:443'
      volumes:
         - ./nginx/nginx.conf:/etc/nginx/nginx.conf
         - ./nginx/ssl:/etc/nginx/ssl
      networks:
         - onway_network
      restart: unless-stopped
      depends_on:
         - app

volumes:
   postgres_data:
   redis_data:

networks:
   onway_network:
      driver: bridge
